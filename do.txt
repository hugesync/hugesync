================================================================================
                         HUGESYNC IMPLEMENTATION PLAN
                              do.txt - Full Roadmap
================================================================================

This document provides a complete, section-by-section implementation plan for
building HugeSync from scratch. Each section is self-contained and buildable.

================================================================================
SECTION 1: PROJECT FOUNDATION & CORE TYPES
================================================================================

[x] 1.1 Create src/lib.rs - Library root with module declarations
    - Declare all modules: config, cli, error, storage, delta, sync, signature

[x] 1.2 Create src/error.rs - Custom error types
    - HugeSyncError enum with thiserror
    - Variants: Io, Network, Storage, Config, Delta, Conflict, Cancelled

[x] 1.3 Create src/config.rs - Configuration management
    - SyncConfig struct: delta_threshold, jobs, dry_run, delete, progress, etc.
    - ConfigFile struct for ~/.config/hugesync/config.toml
    - Load/save config with serde + toml
    - Merge CLI args with file config (CLI wins)

[x] 1.4 Create src/types.rs - Core domain types
    - FileEntry: path, size, mtime, mode, is_dir
    - SyncAction enum: Upload, Download, Delete, Skip, Delta
    - SyncStats: files_scanned, bytes_transferred, bytes_saved, duration
    - AtomicSyncStats: thread-safe version with atomic counters

================================================================================
SECTION 2: CLI INTERFACE
================================================================================

[x] 2.1 Create src/cli.rs - Clap argument definitions
    - Main Cli struct with subcommands
    - SyncCommand: source, destination, all flags from plan.md
    - Flags: -a, -n, -v, -P, -j, --delete, --delta-threshold, --block-size

[x] 2.2 Update src/main.rs - Entry point
    - Parse CLI with clap
    - Initialize tracing subscriber (JSON or pretty based on env)
    - Build Config from CLI + config file
    - Dispatch to sync command (ACTUALLY CALLS SYNCENGINE)
    - Handle Ctrl+C gracefully with tokio signal

================================================================================
SECTION 3: URI PARSING & STORAGE ABSTRACTION
================================================================================

[x] 3.1 Create src/uri.rs - URI parsing
    - Location enum: Local(PathBuf), S3 { bucket, prefix }, Gcs { bucket, prefix }, Azure { container, prefix }
    - Parse "s3://bucket/path", "gs://bucket/path", "az://container/path"
    - Validate and normalize paths

[x] 3.2 Create src/storage/mod.rs - Storage enum
    - StorageBackend enum with Local and S3 variants
    - Methods: list, get, put, delete, head
    - Multipart: create_multipart_upload, upload_part, upload_part_copy, complete, abort

[x] 3.3 Create src/storage/local.rs - Local filesystem backend
    - Implement methods for LocalBackend
    - Use jwalk for parallel directory walking
    - Handle symlinks, permissions, hidden files

[x] 3.4 Create src/storage/s3.rs - AWS S3 backend
    - Implement methods for S3Backend
    - Use aws-sdk-s3 for low-level operations
    - Implement UploadPartCopy for delta stitching
    - Handle multipart uploads

[ ] 3.5 Create src/storage/gcs.rs - Google Cloud Storage backend
    - (Deferred) GCS compose support

[ ] 3.6 Create src/storage/azure.rs - Azure Blob Storage backend
    - (Deferred) Azure Block List support

[x] 3.7 Create src/storage/ssh.rs - SSH/SFTP backend
    - Pure Rust SSH via russh/russh-sftp
    - Agent and key-file authentication
    - Full SFTP operations (list, get, put, delete)

================================================================================
SECTION 4: SIGNATURE & DELTA ENGINE
================================================================================

[x] 4.1 Create src/signature/mod.rs - Signature types
    - Signature struct: block_size, checksums: Vec<BlockChecksum>
    - BlockChecksum: rolling_hash (u32), strong_hash (blake3, 32 bytes)
    - SIGNATURE_MAGIC, VERSION for file format

[x] 4.2 Create src/signature/generate.rs - Signature generation
    - generate_signature(reader, block_size) -> Signature
    - Use rolling checksums (Adler32-like)
    - Use blake3 with rayon for parallel strong hashing

[x] 4.3 Create src/signature/file.rs - .hssig file format
    - Write signature to binary format
    - Read signature from binary format
    - Include source file ETag/mtime for staleness detection

[x] 4.4 Create src/delta/mod.rs - Delta computation
    - Delta struct: operations: Vec<DeltaOp>
    - DeltaOp enum: Copy { src_offset, len }, Insert { data }

[x] 4.5 Create src/delta/compute.rs - Delta algorithm
    - compute_delta(local_file, remote_signature) -> Delta
    - Use rolling hash matching
    - Coalesce adjacent Copy operations
    - Track bytes reused vs bytes new

[x] 4.6 Create src/delta/coalesce.rs - S3-aware chunk coalescing
    - Ensure no part < 5MB (S3 minimum)
    - Merge small Insert operations
    - Align operations to 5MB boundaries where possible
    - Zero-copy Bytes handling for uploads

================================================================================
SECTION 5: SYNC ENGINE
================================================================================

[x] 5.1 Create src/sync/mod.rs - Sync orchestration
    - SyncEngine struct with config, source, dest backends
    - Main sync() method

[x] 5.2 Create src/sync/scan.rs - Parallel file scanning
    - Scan source and destination concurrently
    - Use jwalk in spawn_blocking
    - Build file tree with sizes, mtimes, hashes

[x] 5.3 Create src/sync/diff.rs - Diff calculation
    - Compare source and dest file lists
    - Determine SyncAction for each file:
        - New file -> Upload
        - Missing file -> Delete (if --delete)
        - Same mtime+size -> Skip
        - Different -> Upload or Delta

[x] 5.4 Create src/sync/plan.rs - Sync plan generation
    - SyncPlan struct: Vec<PlannedAction>
    - PlannedAction: file, action, estimated_bytes
    - Calculate total bytes to transfer
    - Calculate estimated savings from delta

[x] 5.5 Create src/sync/execute.rs - Sync execution
    - Execute plan with concurrency control (semaphore)
    - For small files: direct upload/download
    - Track progress, update stats

[x] 5.6 Create src/sync/delta_upload.rs - Delta upload pipeline
    - Download remote .hssig (or generate if missing)
    - Compute delta locally
    - Initiate multipart upload
    - Upload changed chunks
    - Use UploadPartCopy for unchanged chunks
    - Complete multipart upload
    - Upload new .hssig

[x] 5.7 Create src/sync/conflict.rs - Conflict resolution
    - Check ETag before upload (If-Match)
    - Handle concurrent modifications
    - --fail-on-conflict: abort
    - Default: retry with fresh diff

================================================================================
SECTION 6: PROGRESS & UX
================================================================================

[x] 6.1 Create src/progress.rs - Progress tracking
    - ProgressTracker with indicatif MultiProgress
    - Overall progress bar (files)
    - Current file progress bar (bytes)
    - Delta savings display
    - Dry-run summary output

[x] 6.2 Create src/format.rs - Output formatting
    - Format file sizes (human_bytes)
    - Format durations
    - Format transfer rates
    - Dry-run report format

================================================================================
SECTION 7: RESUME & RELIABILITY
================================================================================

[x] 7.1 Create src/resume.rs - Resume state management
    - ResumeState struct: upload_id, completed_parts, file_path
    - Persist to ~/.cache/hugesync/uploads/<hash>.json
    - Load on startup, resume incomplete uploads
    - Clean up after successful completion

[x] 7.2 Create src/retry.rs - Retry logic
    - Exponential backoff with jitter
    - Configurable max retries
    - Distinguish retryable vs fatal errors

================================================================================
SECTION 8: RSYNC-COMPATIBLE FEATURES (NEW)
================================================================================

This section adds rsync-compatible options for full feature parity.

[x] 8.1 Comparison Mode Options
    - --checksum / -c: Use checksums instead of mtime+size for comparison
    - --size-only: Compare by file size only (ignore mtime)
    - --update / -u: Skip files newer on the receiver
    - --ignore-existing: Skip files that already exist on receiver
    - --existing: Only update files that already exist on receiver
    - --modify-window=NUM: Compare mod times with tolerance (seconds)

[x] 8.2 File Size Filtering
    - --max-size=SIZE: Don't transfer files larger than SIZE
    - --min-size=SIZE: Don't transfer files smaller than SIZE
    - SIZE format: 100, 100K, 100M, 100G

[ ] 8.3 Symlink Handling
    - --links / -l: Copy symlinks as symlinks (default in archive mode)
    - --copy-links / -L: Transform symlinks into referent file/dir
    - --safe-links: Ignore symlinks pointing outside tree
    - --copy-unsafe-links: Only copy unsafe symlinks as files

[ ] 8.4 Transfer Mode Options
    - --whole-file / -W: Disable delta-transfer, always copy whole files
    - --inplace: Update destination files in-place
    - --append: Append data to shorter files
    - --append-verify: Like --append but verify with checksum

[x] 8.5 Backup Functionality
    - --backup / -b: Make backups of changed files
    - --backup-dir=DIR: Store backups in specified directory
    - --suffix=SUFFIX: Backup suffix (default: ~)

[x] 8.6 Bandwidth Limiting
    - --bwlimit=RATE: Limit bandwidth in KiB/s
    - Rate limiting via token bucket algorithm
    - Apply to both upload and download

[ ] 8.7 Partial Transfer Support
    - --partial: Keep partially transferred files
    - --partial-dir=DIR: Put partial files in a directory
    - Resume from partial files on restart

[ ] 8.8 Source File Handling
    - --remove-source-files: Remove source files after successful transfer
    - --delay-updates: Put all updated files into place at end

[x] 8.9 Output & Logging
    - --itemize-changes / -i: Output change summary for each file
      Format: YXcstpoguax (like rsync)
    - --log-file=FILE: Log transfers to a file
    - --stats: Show detailed transfer statistics at end
    - --human-readable / -h: Output numbers in human-readable format (default)

[ ] 8.10 Compare/Copy/Link Destination
    - --compare-dest=DIR: Compare against files in DIR (if missing at dest)
    - --copy-dest=DIR: Copy from DIR if file matches (instead of source)
    - --link-dest=DIR: Hardlink to files in DIR when unchanged

[ ] 8.11 Filesystem Boundary
    - --one-file-system / -x: Don't cross filesystem boundaries

[ ] 8.12 Archive Mode Expansion
    - -a / --archive = -rlptgoD (recursive, links, perms, times, group, owner, devices)
    - --no-OPTION: Disable individual archive components

================================================================================
SECTION 9: INTEGRATION & TESTING
================================================================================

[x] 9.1 Create tests/integration_local.rs
    - Test local-to-local sync
    - Test file creation, modification, deletion
    - Test filtering (include/exclude)

[ ] 9.2 Create tests/integration_s3.rs
    - (Requires localstack/minio for testing)

[x] 9.3 Create tests/delta_tests.rs
    - Test signature generation
    - Test delta computation
    - Test chunk coalescing
    - Verify byte savings

[ ] 9.4 Create tests/rsync_compat_tests.rs
    - Test rsync option compatibility
    - Test comparison modes
    - Test filtering options
    - Test backup functionality

[ ] 9.5 Create benches/scan_bench.rs
    - (Deferred)

[ ] 9.6 Create benches/delta_bench.rs
    - (Deferred)

================================================================================
SECTION 10: POLISH & DOCUMENTATION
================================================================================

[x] 10.1 Update README.md
    - Installation instructions
    - Quick start examples
    - Configuration reference
    - Performance tips

[x] 10.2 Create CHANGELOG.md
    - Initial release notes

[ ] 10.3 Create examples/
    - (Deferred)

================================================================================
IMPLEMENTATION ORDER FOR RSYNC FEATURES
================================================================================

Phase 1 - Core Comparison (DONE):
  [x] 8.1 Comparison modes (checksum, size-only, update, ignore-existing, existing)
  [x] 8.2 File size filtering (max-size, min-size)
  [ ] 8.4 Transfer modes (whole-file, inplace) - CLI added, integration pending

Phase 2 - File Handling:
  [ ] 8.3 Symlink handling (links, copy-links, safe-links) - CLI added
  [x] 8.5 Backup functionality
  [ ] 8.8 Source file handling (remove-source-files) - CLI added

Phase 3 - Performance & Control:
  [x] 8.6 Bandwidth limiting
  [ ] 8.7 Partial transfer support - CLI added
  [ ] 8.11 Filesystem boundary - CLI added

Phase 4 - Output & Advanced:
  [x] 8.9 Itemize changes and logging
  [ ] 8.10 Compare/copy/link destination - CLI added
  [ ] 8.12 Archive mode expansion

================================================================================
KEY DESIGN DECISIONS
================================================================================

1. Block Size: Default 5MB (configurable 64KB-5MB via --block-size)
   - 5MB aligns with S3 minimum part size
   - Smaller blocks = more granular deltas but more overhead
   - Range: 64KB (65536) to 5MB (5242880)
2. Parallelism: Use rayon for CPU-bound, tokio for I/O-bound
3. Memory: Stream large files, never load fully into memory
4. Sidecar Location: Same path as file with .hssig extension
5. Config Priority: CLI > env vars > config file > defaults

CODE QUALITY OBSERVATIONS:
--------------------------

1. Error Handling: Consistent use of thiserror with proper error variants
2. Testing: 88+ tests covering core functionality (all passing)
3. Memory Safety: Uses memmap2 for large files to avoid OOM
4. Async: Proper tokio async/await patterns throughout
5. Cloud Backends: S3, GCS, Azure, SSH all implement same interface
6. Zero-Copy: Uses Bytes for efficient data transfer
7. Atomic Stats: Thread-safe statistics with AtomicU64 counters
8. Rsync Compat: Core comparison modes, backup, bandwidth limiting, itemized output
9. Streaming Transfers: Large files use get_stream()/put_stream() to avoid loading into RAM
   - Files < 8MB: Simple in-memory transfer
   - Local source: Uses put_file() with memory-mapped streaming
   - Cloud-to-cloud: Streams chunks directly between backends

SSH STREAMING SUPPORT:
----------------------
- True streaming upload via put_stream() - writes chunks as they arrive
- Chunked download via get_stream() - reads in 16MB chunks using seek/read
- Range read via get_range() - seeks to position, reads only needed bytes
- No multipart upload support (uses incremental write instead)
- No server-side copy support (full file transfer required for delta)
- Delta sync falls back to full upload for SSH destinations
- Passphrase-protected keys not yet supported (use ssh-agent)

TESTING:
--------
SSH tests are ignored by default (require real SSH server).
Run with: SSH_TEST_HOST=hostname SSH_TEST_USER=user cargo test ssh --ignored

================================================================================
